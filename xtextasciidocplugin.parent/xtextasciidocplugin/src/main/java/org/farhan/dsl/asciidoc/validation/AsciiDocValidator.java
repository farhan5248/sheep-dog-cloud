/*
 * generated by Xtext 2.36.0
 */
package org.farhan.dsl.asciidoc.validation;

import java.io.File;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.eclipse.core.resources.IFile;
import org.eclipse.core.resources.ResourcesPlugin;
import org.eclipse.core.runtime.Path;
import org.eclipse.emf.ecore.resource.Resource;
import org.eclipse.xtext.validation.Check;
import org.eclipse.xtext.validation.CheckType;
import org.farhan.dsl.asciidoc.asciiDoc.TestStepContainer;
import org.farhan.dsl.asciidoc.asciiDoc.Cell;
import org.farhan.dsl.asciidoc.asciiDoc.Row;
import org.farhan.dsl.asciidoc.asciiDoc.AsciiDocPackage;
import org.farhan.dsl.asciidoc.asciiDoc.TestSuite;
import org.farhan.dsl.asciidoc.asciiDoc.TestStep;
import org.farhan.dsl.asciidoc.asciiDoc.Table;
import org.farhan.dsl.asciidoc.asciiDoc.Text;
import org.farhan.dsl.asciidoc.impl.CellImpl;
import org.farhan.dsl.asciidoc.impl.RowImpl;
import org.farhan.dsl.asciidoc.impl.TestStepContainerImpl;
import org.farhan.dsl.asciidoc.impl.TestStepImpl;
import org.farhan.dsl.asciidoc.impl.TestSuiteImpl;
import org.farhan.dsl.asciidoc.impl.TextImpl;
import org.farhan.dsl.issues.*;
import org.farhan.dsl.lang.ITestProject;
import org.farhan.dsl.lang.SheepDogFactory;

/**
 * This class contains custom validation rules.
 *
 * See
 * https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#validation
 */
public class AsciiDocValidator extends AbstractAsciiDocValidator {

	private static final Logger logger = LoggerFactory.getLogger(AsciiDocValidator.class);
	public static final String CELL_NAME_ONLY = "CELL_NAME_ONLY";
	public static final String TEST_STEP_CONTAINER_NAME_ONLY = "TEST_STEP_CONTAINER_NAME_ONLY";
	public static final String TEST_STEP_CONTAINER_TEST_STEP_FILE_LIST_FILE = "TEST_STEP_CONTAINER_TEST_STEP_FILE_LIST_FILE";
	public static final String TEST_SUITE_NAME_ONLY = "TEST_SUITE_NAME_ONLY";
	public static final String TEST_STEP_STEP_OBJECT_NAME_WORKSPACE = "TEST_STEP_STEP_OBJECT_NAME_WORKSPACE";
	public static final String TEST_STEP_STEP_DEFINITION_NAME_WORKSPACE = "TEST_STEP_STEP_DEFINITION_NAME_WORKSPACE";
	public static final String ROW_CELL_LIST_WORKSPACE = "ROW_CELL_LIST_WORKSPACE";
	public static final String TEST_STEP_STEP_OBJECT_NAME_ONLY = "TEST_STEP_STEP_OBJECT_NAME_ONLY";
	public static final String TEST_STEP_STEP_DEFINITION_NAME_ONLY = "TEST_STEP_STEP_DEFINITION_NAME_ONLY";
	public static final String TEXT_NAME_WORKSPACE = "TEXT_NAME_WORKSPACE";

	@Check(CheckType.FAST)
	public void checkCellNameOnly(Cell cell) {
		logger.debug("Entering checkCellNameOnly for element: " + (cell != null ? cell.getName() : "null"));
		initProject(cell.eResource());
		try {
			// TODO make tests for this
			if (cell != null) {
				String problems = CellIssueDetector.validateNameOnly(new CellImpl(cell));
				if (!problems.isEmpty()) {
					warning(problems, AsciiDocPackage.Literals.CELL__NAME, CELL_NAME_ONLY);
				}
			}
		} catch (Exception e) {
			logger.error("Failed in checkCellNameOnly for : " + e.getMessage(), e);

		}
		logger.debug("Exiting checkCellNameOnly");
	}

	@Check(CheckType.FAST)
	public void checkRowCellListWorkspace(Row row) {
		logger.debug("Entering checkRowCellListWorkspace for element: " + (row != null ? row.toString() : "null"));
		try {
			initProject(row.eResource());
			if (row != null && row.eContainer() != null) {
				Table table = (Table) row.eContainer();
				if (table.eContainer() instanceof TestStep) {
					if (!table.getRowList().isEmpty() && table.getRowList().getFirst() == row) {
						String problems = RowIssueDetector.validateCellListWorkspace(new RowImpl(row));
						if (!problems.isEmpty()) {
							warning(problems, AsciiDocPackage.Literals.ROW__CELL_LIST, ROW_CELL_LIST_WORKSPACE);
						}
					}
				}
			}
		} catch (Exception e) {
			logger.error("Failed in checkRowCellListWorkspace for : " + e.getMessage(), e);

		}
		logger.debug("Exiting checkRowCellListWorkspace");
	}

	@Check(CheckType.FAST)
	public void checkTestStepContainerNameOnly(TestStepContainer theTestStepContainer) {
		logger.debug("Entering checkTestStepContainerNameOnly for element: " + theTestStepContainer.getName());
		try {
			initProject(theTestStepContainer.eResource());
			String problems = TestStepContainerIssueDetector
					.validateNameOnly(new TestStepContainerImpl(theTestStepContainer));
			if (!problems.isEmpty()) {
				warning(problems, AsciiDocPackage.Literals.TEST_STEP_CONTAINER__NAME, TEST_STEP_CONTAINER_NAME_ONLY);
			}
		} catch (Exception e) {
			logger.error("Failed in checkTestStepContainerNameOnly for : " + e.getMessage(), e);

		}
		logger.debug("Exiting checkTestStepContainerNameOnly");
	}

	@Check(CheckType.FAST)
	public void checkTestStepContainerTestStepFileListFile(TestStepContainer theTestStepContainer) {
		logger.debug(
				"Entering checkTestStepContainerTestStepFileListFile for element: " + theTestStepContainer.getName());
		try {
			initProject(theTestStepContainer.eResource());
			String problems = TestStepContainerIssueDetector
					.validateTestStepListFile(new TestStepContainerImpl(theTestStepContainer));
			if (!problems.isEmpty()) {
				warning(problems, AsciiDocPackage.Literals.TEST_STEP_CONTAINER__TEST_STEP_LIST,
						TEST_STEP_CONTAINER_TEST_STEP_FILE_LIST_FILE);
			}
		} catch (Exception e) {
			logger.error("Failed in checkTestStepContainerTestStepFileListFile for : " + e.getMessage(), e);

		}
		logger.debug("Exiting checkTestStepContainerTestStepFileListFile");
	}

	@Check(CheckType.FAST)
	public void checkTestStepNameOnly(TestStep step) {
		TestStepImpl testStep = new TestStepImpl(step);
		logger.debug("Entering checkTestStepNameOnly for element: " + testStep.getStepObjectName() + " " + testStep.getStepDefinitionName());
		try {
			initProject(step.eResource());
			String problems = TestStepIssueDetector.validateStepObjectNameOnly(testStep);
			if (!problems.isEmpty()) {
				error(problems, AsciiDocPackage.Literals.TEST_STEP__STEP_OBJECT_NAME, TEST_STEP_STEP_OBJECT_NAME_ONLY);
			} else {
				problems = TestStepIssueDetector.validateStepDefinitionNameOnly(testStep);
				if (!problems.isEmpty()) {
					error(problems, AsciiDocPackage.Literals.TEST_STEP__STEP_DEFINITION_NAME,
							TEST_STEP_STEP_DEFINITION_NAME_ONLY);
				}
			}
		} catch (Exception e) {
			logger.error("Failed in checkTestStepNameOnly for : " + e.getMessage(), e);

		}
		logger.debug("Exiting checkTestStepNameOnly");
	}

	@Check(CheckType.FAST)
	public void checkTestStepNameWorkspace(TestStep step) {
		TestStepImpl testStep = new TestStepImpl(step);
		logger.debug("Entering checkTestStepNameWorkspace for element: " + testStep.getStepObjectName() + " " + testStep.getStepDefinitionName());
		try {
			initProject(step.eResource());
			String problems = TestStepIssueDetector.validateStepObjectNameWorkspace(testStep);
			if (!problems.isEmpty()) {
				warning(problems, AsciiDocPackage.Literals.TEST_STEP__STEP_OBJECT_NAME,
						TEST_STEP_STEP_OBJECT_NAME_WORKSPACE);
			} else {
				problems = TestStepIssueDetector.validateStepDefinitionNameWorkspace(testStep);
				if (!problems.isEmpty()) {
					warning(problems, AsciiDocPackage.Literals.TEST_STEP__STEP_DEFINITION_NAME,
							TEST_STEP_STEP_DEFINITION_NAME_WORKSPACE);
				}
			}
		} catch (Exception e) {
			logger.error("Failed in checkTestStepNameWorkspace for : " + e.getMessage(), e);

		}
		logger.debug("Exiting checkTestStepNameWorkspace");
	}

	@Check(CheckType.FAST)
	public void checkTestSuiteNameOnly(TestSuite theTestSuite) {
		logger.debug("Entering checkTestSuiteNameOnly for element: " + theTestSuite.getName());
		initProject(theTestSuite.eResource());
		try {
			// TODO validate that feature file name and feature name are the same.
			TestSuiteImpl testSuiteImpl = new TestSuiteImpl(theTestSuite);
			String problems = TestSuiteIssueDetector.validateNameOnly(testSuiteImpl);
			if (!problems.isEmpty()) {
				warning(problems, AsciiDocPackage.Literals.MODEL__NAME, TEST_SUITE_NAME_ONLY);
			}
		} catch (Exception e) {
			logger.error("Failed in checkTestSuiteNameOnly for : " + e.getMessage(), e);

		}
		logger.debug("Exiting checkTestSuiteNameOnly");
	}

	@Check(CheckType.FAST)
	public void checkTextNameWorkspace(Text text) {
		logger.debug("Entering checkTextNameWorkspace for element: " + (text != null ? text.getName() : "null"));
		initProject(text.eResource());
		if (text != null) {
			try {
				String problems = TextIssueDetector.validateNameWorkspace(new TextImpl(text));
				if (!problems.isEmpty()) {
					warning(problems, AsciiDocPackage.Literals.TEXT__NAME, TEXT_NAME_WORKSPACE);
				}
			} catch (Exception e) {
				logger.error("Failed in checkTextNameWorkspace for : " + e.getMessage(), e);
			}
		}
		logger.debug("Exiting checkTextNameWorkspace");
	}

	private void initProject(Resource resource) {
		ITestProject parent = SheepDogFactory.instance.createTestProject();
		String resourcePath = resource.getURI().toFileString().replace(File.separator, "/");
		String projectPath = resourcePath.split("src/test/resources/asciidoc/specs/")[0].replace("/",
				File.separator);
		parent.setName(new File(projectPath).getAbsolutePath());
	}
}
